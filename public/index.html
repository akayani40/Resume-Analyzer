<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ParsePro</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <!-- Add jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
  </script>
  <style>
    /* card background respects theme */
    :root {
      --card-bg-light: #ffffff;
      --card-bg-dark:  #1c1c1c;
    }
    [data-theme="light"] .content-card { background: var(--card-bg-light); color: #111; }
    [data-theme="dark"]  .content-card { background: var(--card-bg-dark);  color: #f1f1f1; }

    /* remove inner feature-panel boxes */
    .feature { background: transparent; border: none; }

    /*  add once, just after the other styles  */
    .footer-content.disabled {
      pointer-events: none;
      opacity: 0.35;                 /* visual cue while analysis runs */
    }

    .contact-form textarea {
      resize: vertical;
      max-height: 260px;   /* prevents the card from stretching */
    }

    /* put these with the other styles */
    .contact-form          { max-width: 600px; margin: 0 auto; }
    .contact-form textarea { overflow-y: auto; max-height: 260px; }

    /* Contact form sizing */
    .contact-form          { width: 100%; padding-right: 24px; }
    .contact-form input,
    .contact-form textarea { width: 100%; }

    .contact-form textarea {
      overflow-y: auto;
      max-height: 260px;
    }

    /* Job-Match layout */
    .job-match-wrapper { width: 100%; }
    .job-match-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
    }
    .match-card {
      flex: 1 1 300px;
      background: var(--bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      color: var(--text);
    }
  </style>
</head>
<body>
  <!-- Theme Toggle -->
  <label class="switch">
    <input type="checkbox" id="modeToggle" />
    <span class="slider round"></span>
  </label>

  <!--
  <div id="statusBubble" class="status-bubble">
    ‚ö†Ô∏è Parser temporarily offline while we resolve OpenAI API issues. Thanks for your patience!
  </div>
  -->

  <div class="container">
<div style="text-align: center; margin-bottom: 60px;">
      <!-- Inline SVG logo with animated circles -->
      <svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" width="560" height="100" viewBox="0 0 560 100">
        <defs>
          <style>
            .dark-circle{fill:#1a1a1a}
            .yellow-circle{fill:#69995D}
            .white-text{fill:#fff;font-family:Helvetica,Arial,sans-serif;font-size:42px;font-weight:700;dominant-baseline:middle;text-anchor:middle}
            .black-text{fill:#000;font-family:Helvetica,Arial,sans-serif;font-size:42px;font-weight:700;dominant-baseline:middle;text-anchor:middle}
          </style>
        </defs>
        <g class="logo-circle delay0"><circle class="dark-circle" cx="30" cy="50" r="30"/><text class="white-text" x="30" y="52">P</text></g>
        <g class="logo-circle delay1"><circle class="dark-circle" cx="100" cy="50" r="30"/><text class="white-text" x="100" y="52">A</text></g>
        <g class="logo-circle delay2"><circle class="dark-circle" cx="170" cy="50" r="30"/><text class="white-text" x="170" y="52">R</text></g>
        <g class="logo-circle delay3"><circle class="dark-circle" cx="240" cy="50" r="30"/><text class="white-text" x="240" y="52">S</text></g>
        <g class="logo-circle delay4"><circle class="dark-circle" cx="310" cy="50" r="30"/><text class="white-text" x="310" y="52">E</text></g>
        <g class="logo-circle delay5"><circle class="yellow-circle" cx="380" cy="50" r="30"/><text class="black-text" x="380" y="52">P</text></g>
        <g class="logo-circle delay6"><circle class="yellow-circle" cx="450" cy="50" r="30"/><text class="black-text" x="450" y="52">R</text></g>
        <g class="logo-circle delay7"><circle class="yellow-circle" cx="520" cy="50" r="30"/><text class="black-text" x="520" y="52">O</text></g>
      </svg>
      <p style="font-size: 18px; margin-top: 8px; color: var(--text); opacity: 0.9;">
        Because parsing isn't enough ‚Äî you need insight. See what recruiters (and AI) see.
      </p>
      <div style="width: 60px; height: 1px; background-color: var(--text); opacity: 0.2; margin: 20px auto;"></div>
    </div>

    <!-- Move #controls here -->
    <div id="controls" style="display: none; gap: 10px; margin-top: 0;">
      <button onclick="toggleView('atsView')">üìÑ ATS View</button>
      <button onclick="toggleView('jobMatchView')">üß© Job Match</button>
      <button onclick="toggleView('chatView')">üí¨ Chat & Edit</button>
      <button id="newUploadBtn">üîÑ New Upload</button>
    </div>

<div class="upload-center" id="uploadUI">
  <form id="resumeForm" enctype="multipart/form-data">
    <div class="upload-area" id="drop-zone">
      <div class="upload-icon">üìÑ</div>
      <p class="upload-text">Select or drag your file</p>
      <input id="resumeUpload" type="file" name="resume" accept=".pdf,.docx,.txt" required />
    </div>
  </form>
</div>

<div id="progressWrapper" class="fade" style="display: none; text-align: center;">
  <p id="progressMessage" class="upload-text">Uploading and analyzing your resume... Getting you the best results.</p>
  <div id="progressText">0%</div>
  <div class="progress-container" id="progressBarContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
      <p class="wait-message">Please wait up to 2 minutes for everything to load. Doing our best to provide the best results.</p>
    </div>

    <div id="atsView" style="display: none;">
      <div class="job-match-wrapper">
        <div class="job-match-grid">
          <div class="match-card">
            <h3>üìä Scores</h3>
            <p><strong>Target Field:</strong> ${ev.inferredField || '‚Äî'}</p>
            <p><strong>ATS Score:</strong> ${ev.atsScore ?? '‚Äî'}%</p>
            <p><strong>Recruiter Score:</strong> ${ev.recruiterEngagementLikelihood || '‚Äî'}</p>
            <p><strong>Career-Readiness:</strong> ${ev.careerReadinessScore || '‚Äî'}</p>
            <p><strong>Tone Analysis:</strong> ${ev.toneAnalysis || '‚Äî'}</p>
            <p><strong>Risk Level:</strong> ${ev.riskLevel || '‚Äî'}</p>
            <p><strong>Priority Section:</strong> ${ev.prioritySection || '‚Äî'}</p>
          </div>

          <div class="match-card">
            <h3>‚ú® What Recruiters Will Love</h3>
            ${listMarkup(ev.whatRecruitersWillLove)}

            <h3 style="margin-top: 24px;">üõë Major Gaps / Red Flags</h3>
            ${listMarkup(ev.redFlags)}
          </div>

          <div class="match-card">
            <h3>‚ö†Ô∏è Soft Issues</h3>
            ${listMarkup(ev.softIssues)}

            <h3 style="margin-top: 24px;">üö´ Link / Info Red Flags</h3>
            ${listMarkup(ev.linkRedFlags)}
          </div>
        </div>

        <div class="match-card suggestion-box" style="margin-top: 40px;">
          <h3>üí° AI Suggestions</h3>
          ${listMarkup(ev.topFixes)}
        </div>
      </div>
    </div>
    <div id="jobMatchView" style="display: none;">
      <div class="job-match-wrapper">
        <div class="match-card input-card">
          <h3>üß© Compare Your Resume</h3>
          <p style="font-size:0.92em;opacity:0.8;margin-bottom:12px;">Paste the target job description below and click Compare. We'll highlight strengths, gaps, and provide AI suggestions.</p>
          <textarea id="jdInput" placeholder="Paste job description here..."></textarea>
          <button id="compareBtn" class="analyze-btn" style="margin-top:14px;">Compare</button>
        </div>
        <div id="compareResult" style="margin-top:24px;"></div>
      </div>
    </div>
    <div id="chatView" style="display: none;">
      <div class="chat-resume-container">
        <div class="chat-section">
          <h3>üí¨ Chat with AI Assistant</h3>
          <div class="chat-container">
            <div id="chatMessages" class="chat-messages">
              <!-- Chat messages will appear here -->
            </div>
            <div class="chat-input-container">
              <textarea id="chatInput" class="chat-input" placeholder="Ask for resume advice or editing suggestions..."></textarea>
              <button id="sendMessage" class="chat-send-btn">Send</button>
            </div>
          </div>
        </div>
        
        <div class="resume-section">
          <h3>Resume Editor</h3>
          <div class="editor-toolbar">
            <button id="downloadResume" class="download-btn">Download as PDF</button>
          </div>
          <div id="resumeEditor" class="resume-editor" contenteditable="true">
            <!-- Resume content will be loaded here with formatting preserved -->
            <div class="resume-placeholder">Your formatted resume will appear here after upload.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-content">
      <a href="#about" class="footer-link" onclick="showPage('about'); return false;">About ParsePro</a>
      <span class="footer-divider">|</span>
      <a href="#how-it-works" class="footer-link" onclick="showPage('how-it-works'); return false;">How It Works</a>
      <span class="footer-divider">|</span>
      <a href="#contact" class="footer-link" onclick="showPage('contact'); return false;">Contact</a>
      <span class="footer-divider">|</span>
      <a href="https://github.com/akayani40/Resume-Analyzer" class="footer-link" target="_blank">GitHub</a>
    </div>
  </footer>

  <!-- Page Content -->
  <div id="pageContent" class="page-content" style="display: none;">
    <div id="about" class="page" style="display: none;">
      <h2 class="animated-header" id="about-header"></h2>
      <div class="content-card">
        <p>ParsePro is an AI-powered resume analyzer that helps job seekers optimize their resumes for both human recruiters and ATS systems. Our mission is to bridge the gap between traditional resume writing and modern recruitment technology.</p>
        <div class="feature-grid">
          <div class="feature">
            <span class="feature-icon">üéØ</span>
            <h3>Precision Analysis</h3>
            <p>Get detailed insights into how your resume performs in modern ATS systems</p>
          </div>
          <div class="feature">
            <span class="feature-icon">ü§ñ</span>
            <h3>AI-Powered</h3>
            <p>Leveraging advanced AI to provide personalized recommendations</p>
          </div>
          <div class="feature">
            <span class="feature-icon">üîí</span>
            <h3>Privacy First</h3>
            <p>Your data is never stored - we process everything in real-time</p>
          </div>
        </div>
      </div>
    </div>

    <div id="how-it-works" class="page" style="display: none;">
      <h2 class="animated-header" id="how-header"></h2>
      <div class="content-card">
        <div class="step-container">
          <div class="step">
            <div class="step-number">1</div>
            <h3>Upload Your Resume</h3>
            <p>Simply drag and drop your resume or select it from your files</p>
          </div>
          <div class="step">
            <div class="step-number">2</div>
            <h3>AI Analysis</h3>
            <p>Our AI analyzes your resume for ATS compatibility and content quality</p>
          </div>
          <div class="step">
            <div class="step-number">3</div>
            <h3>Get Insights</h3>
            <p>Receive detailed feedback and suggestions for improvement</p>
          </div>
          <div class="step">
            <div class="step-number">4</div>
            <h3>Chat & Edit</h3>
            <p>Interact with our AI assistant to refine your resume further</p>
          </div>
        </div>
      </div>
    </div>

    <div id="contact" class="page" style="display: none;">
      <h2 class="animated-header" id="contact-header"></h2>
      <div class="content-card">
        <div class="contact-grid">
          <div class="contact-info">
            <h3>Get in Touch</h3>
            <p>Have questions or feedback? We'd love to hear from you!</p>
            <div class="contact-methods">
              <div class="contact-method">
                <span class="contact-icon">üìß</span>
                <p>ali@alikayani.com</p>
              </div>
              <div class="contact-method">
                <span class="contact-icon">üîó</span>
                <p><a href="https://www.linkedin.com/in/ali-kayani/" target="_blank" style="color: inherit; text-decoration: none;">Connect on LinkedIn</a></p>
              </div>
            </div>
          </div>
          <form class="contact-form" id="contactForm" action="https://formspree.io/f/xblyagvn" method="POST" onsubmit="return false;">
            <input type="text" name="name" placeholder="Your Name" required>
            <input type="email" name="email" placeholder="Your Email" required>
            <textarea name="message" placeholder="Your Message" required></textarea>
            <button type="submit">Send Message</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <style>
    .page-content {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      color: var(--text);
    }

    .page {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }

    .content-card {
      background: var(--bg);
      border-radius: 12px;
      padding: 30px;
      margin-top: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      color: var(--text);
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .feature {
      text-align: center;
      padding: 20px;
      background: transparent;      /* remove black box */
      border: none;
      transition: transform 0.3s ease;
    }

    .feature:hover {
      transform: translateY(-5px);
    }

    .feature h3 {
      color: var(--text);
      margin: 10px 0;
    }

    .feature p {
      color: var(--text-secondary);
    }

    .feature-icon {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .step-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 30px;
      margin-top: 30px;
    }

    .step {
      text-align: center;
      position: relative;
      color: var(--text);
    }

    .step h3 {
      color: var(--text);
      margin: 10px 0;
    }

    .step p {
      color: var(--text-secondary);
    }

    .step-number {
      width: 40px;
      height: 40px;
      background: var(--primary);
      color: var(--step-number-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      border: 2px solid var(--primary-dark);
      font-size: 1.2em;
    }

    .step-number:hover {
      transform: scale(1.1);
      transition: transform 0.2s ease;
    }

    .contact-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
    }

    .contact-info {
      color: var(--text);
    }

    .contact-info h3 {
      color: var(--text);
      margin-bottom: 15px;
    }

    .contact-info p {
      color: var(--text-secondary);
    }

    .contact-methods {
      margin-top: 20px;
    }

    .contact-method {
      display: flex;
      align-items: center;
      margin: 15px 0;
      color: var(--text);
    }

    .contact-icon {
      font-size: 1.5em;
      margin-right: 10px;
    }

    .contact-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .contact-form input,
    .contact-form textarea {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      transition: border-color 0.3s ease;
    }

    .contact-form input:focus,
    .contact-form textarea:focus {
      border-color: var(--primary);
      outline: none;
    }

    .contact-form textarea {
      min-height: 150px;
      resize: vertical;
    }

    .contact-form button {
      padding: 14px 32px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--button-text-color);
      border: none;
      border-radius: 32px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.08em;
      letter-spacing: 0.7px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.10);
      transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
      outline: none;
    }

    .contact-form button:hover, .contact-form button:focus {
      background: linear-gradient(90deg, var(--primary-dark) 0%, var(--primary) 100%);
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.18), 0 0 0 4px rgba(80,120,255,0.10);
      transform: scale(1.04);
      color: var(--button-text-color);
    }

    .footer-link {
      color: var(--text);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .footer-link:hover {
      color: var(--primary);
    }

    .footer-divider {
      color: var(--text-secondary);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .contact-grid {
        grid-template-columns: 1fr;
      }
    }

    .animated-header {
      text-align: center;
      font-size: 2.2em;
      font-weight: 700;
      margin-bottom: 32px;
      letter-spacing: normal;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0;
      white-space: pre;
    }
    .animated-header span {
      display: inline-block;
      opacity: 0;
      transform: translateY(18px) scale(0.93) rotate(-3deg);
      animation: popIn 0.6s cubic-bezier(.68,-0.55,.27,1.55) forwards;
      will-change: transform, opacity;
    }
    @keyframes popIn {
      0% { opacity: 0; transform: translateY(18px) scale(0.93) rotate(-3deg); }
      60% { opacity: 1; transform: translateY(-4px) scale(1.04) rotate(2deg); }
      80% { opacity: 1; transform: translateY(1px) scale(0.98) rotate(-1deg); }
      100% { opacity: 1; transform: translateY(0) scale(1) rotate(0); }
    }
    .progress-transition {
      transition: opacity 0.5s, transform 0.5s;
      opacity: 1;
      transform: translateY(0);
    }
    .progress-transition.hide {
      opacity: 0;
      transform: translateY(-40px);
      pointer-events: none;
    }
    .tabs-transition {
      opacity: 0;
      transform: translateY(40px);
      transition: opacity 0.5s, transform 0.5s;
      pointer-events: none;
    }
    .tabs-transition.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    #controls.centered-tabs {
      display: flex !important;
      justify-content: center;
      gap: 16px;
      margin-top: 40px;
      margin-bottom: 0;
      position: relative;
      z-index: 2;
    }
    .logo-svg {
      width: 400px;
      max-width: 90%;
      height: auto;
      display: block;
      margin: 0 auto;
      overflow: visible; /* allow circles to move without being clipped */
    }

    /* Bounce-in animation */
    @keyframes bounceInOnce {
      0% { opacity: 0; transform: translateY(30px) scale(0.9); }
      60% { opacity: 1; transform: translateY(-10px) scale(1.05); }
      80% { transform: translateY(4px) scale(0.98); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .logo-circle {
      opacity: 0;
      transform-box: fill-box;
      transform-origin: center bottom;
      animation: bounceInOnce 0.7s ease-out forwards;
      transition: transform 0.25s ease;
    }
    .delay0 { animation-delay: 0.05s; }
    .delay1 { animation-delay: 0.15s; }
    .delay2 { animation-delay: 0.25s; }
    .delay3 { animation-delay: 0.35s; }
    .delay4 { animation-delay: 0.45s; }
    .delay5 { animation-delay: 0.55s; }
    .delay6 { animation-delay: 0.65s; }
    .delay7 { animation-delay: 0.75s; }

    /* Hover lift */
    .logo-circle:hover {
      transform: translateY(-8px) scale(1.05);
    }

    /* Slide-up panel, anchored above the footer */
    #pageContent {
      display: none;           /* revealed when footer link clicked */
      padding-top: 40px;       /* spacing below the upload area */
    }

    /* smooth slide-up */
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to   { transform: translateY(0);   opacity: 1; }
    }

    /* make inner "page" cards blend with theme */
    #pageContent .content-card {
      background: var(--card-bg-light);
      color: #111;
    }
    [data-theme="dark"] #pageContent .content-card {
      background: var(--card-bg-dark);
      color: #f1f1f1;
    }

    .footer {
      position: fixed;          /* always pinned */
      left: 0;
      right: 0;
      bottom: 0;                /* flush with bottom edge */
      width: 100%;
      z-index: 1000;
      background: var(--bg);    /* blends with theme */
      transition: transform .35s ease;
      transform: translateY(0); /* visible by default */
    }
  </style>

  <script>
// === global state ===========================================================
let uploadedFile = null;      // remember the resume so we can reuse it later

// Progress bar states with realistic messages and minimum durations (in milliseconds)
const progressStates = [
  { percent: 15, message: "üìÑ Reading your resume...", minDuration: 1000 },
  { percent: 30, message: "üîç Extracting text content...", minDuration: 1500 },
  { percent: 45, message: "ü§ñ Initializing AI analysis...", minDuration: 2000 },
  { percent: 60, message: "üéØ Analyzing skills and experience...", minDuration: 2500 },
  { percent: 75, message: "üìä Evaluating ATS compatibility...", minDuration: 2000 },
  { percent: 90, message: "‚ú® Preparing your detailed insights...", minDuration: 1500 }
];

let currentStateIndex = 0;
let analysisStartTime;

function updateProgressBar(percent, message) {
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const progressMessage = document.getElementById('progressMessage');
  
  // Ensure percent never exceeds 100
  const clampedPercent = Math.min(Math.max(percent, 0), 100);
  
  progressBar.style.width = `${clampedPercent}%`;
  progressText.textContent = `${clampedPercent}%`;
  if (message) {
    progressMessage.textContent = message;
  }
}

function hideUploadUI() {
  const uploadUI = document.getElementById('uploadUI');
  if (uploadUI && uploadUI.style.display !== 'none') {
    uploadUI.classList.add('fade-out');
    setTimeout(() => { uploadUI.style.display = 'none'; }, 700);
  }
}

async function startProgress() {
  hideUploadUI();                   // <‚Äî vanish the file-upload box immediately
  const progressWrapper = document.getElementById('progressWrapper');
  progressWrapper.style.display = 'block';
  progressWrapper.classList.add('show', 'progress-transition');
  
  // Reset progress
  currentStateIndex = 0;
  analysisStartTime = Date.now();
  updateProgressBar(0, progressStates[0].message);

  // Process each state with minimum duration
  for (let i = 0; i < progressStates.length; i++) {
    const state = progressStates[i];
    const nextState = progressStates[i + 1];
    
    // Update to current state
    updateProgressBar(state.percent, state.message);
    
    // Wait for minimum duration
    await new Promise(resolve => setTimeout(resolve, state.minDuration));
    
    // If there's a next state, animate to it
    if (nextState) {
      const steps = (nextState.percent - state.percent) * 2; // Double the steps for smoother animation
      const stepDuration = state.minDuration / steps;
      
      for (let j = 1; j <= steps; j++) {
        const currentPercent = state.percent + ((nextState.percent - state.percent) * (j / steps));
        updateProgressBar(currentPercent, state.message);
        await new Promise(resolve => setTimeout(resolve, stepDuration));
      }
    }
  }
}

async function completeProgress(success = true) {
  // Ensure minimum total duration of 12 seconds
  const elapsedTime = Date.now() - analysisStartTime;
  const minimumDuration = 12000; // 12 seconds
  
  if (elapsedTime < minimumDuration) {
    await new Promise(resolve => setTimeout(resolve, minimumDuration - elapsedTime));
  }
  
  if (success) {
    updateProgressBar(100, "‚úÖ Analysis complete! Displaying your results...");
    await new Promise(r => setTimeout(r, 1000));

    const progressWrapper = document.getElementById('progressWrapper');
    progressWrapper.classList.add('hide');

    const controls = document.getElementById('controls');
    controls.style.display = 'flex';
    controls.classList.add('tabs-transition', 'show');

    // Hide upload UI
    const uploadUI = document.getElementById('uploadUI');
    uploadUI.classList.add('fade-out');
    setTimeout(() => { 
      uploadUI.style.display = 'none';
      progressWrapper.style.display = 'none';
    }, 700);
    
    // Re-enable footer links
    document.querySelector('.footer-content').classList.remove('disabled');
    
    toggleView('atsView');           // now safe ‚Äì function exists
  } else {
    updateProgressBar(95, "‚ùå Analysis failed. Please try again.");
    await new Promise(resolve => setTimeout(resolve, 2000));
    document.getElementById('progressWrapper').style.display = 'none';
  }
}

// === 1.  UNIVERSAL LIST RENDERER =================================
function listMarkup(arr, emptyLabel = '‚Äî') {
  return Array.isArray(arr) && arr.length
    ? '<ul>' + arr.map(item => `<li>${item}</li>`).join('') + '</ul>'
    : `<em>${emptyLabel}</em>`;
}

// === 2.  FULL  ATS-VIEW  RENDERER =================================
function renderAtsEvaluation(ev = {}) {
  return `
  <div class="content-card"><h2>üìä Scores</h2>
    <p><strong>Target Field:</strong> ${ev.inferredField || '‚Äî'}</p>
    <p><strong>ATS Score:</strong> ${ev.atsScore ?? '‚Äî'}%</p>
    <p><strong>Recruiter Score:</strong> ${ev.recruiterEngagementLikelihood || '‚Äî'}</p>
    <p><strong>Career-Readiness:</strong> ${ev.careerReadinessScore || '‚Äî'}</p>
    <p><strong>Tone Analysis:</strong> ${ev.toneAnalysis || '‚Äî'}</p>
    <p><strong>Risk Level:</strong> ${ev.riskLevel || '‚Äî'}</p>
    <p><strong>Priority Section:</strong> ${ev.prioritySection || '‚Äî'}</p>
  </div>

  <div class="content-card"><h3>‚ú® What Recruiters Will Love</h3>
    ${listMarkup(ev.whatRecruitersWillLove)}
  </div>

  <div class="content-card"><h3>üõë Major Gaps / Red Flags</h3>
    ${listMarkup(ev.redFlags)}</div>

  <div class="content-card"><h3>‚ö†Ô∏è Soft Issues</h3>
    ${listMarkup(ev.softIssues)}</div>

  <div class="content-card"><h3>üö´ Link / Info Red Flags</h3>
    ${listMarkup(ev.linkRedFlags)}</div>

  <div class="content-card"><h3>üîç Keyword & Industry Alignment</h3>
    ${listMarkup(ev.keywordAlignment)}</div>

  <div class="content-card"><h3>üìê Formatting & ATS Compatibility</h3>
    ${listMarkup(ev.formattingNotes)}</div>

  <div class="content-card"><h3>üß† Differentiation Factor</h3>
    ${listMarkup(ev.differentiationFactor)}</div>

  <div class="content-card"><h3>üìà Growth & Learning Signals</h3>
    ${listMarkup(ev.growthSignals)}</div>

  <div class="content-card"><h3>üöÄ Top 5 Actionable Fixes</h3>
    ${listMarkup(ev.topFixes)}</div>

  <div class="content-card"><h3>üìö Learning Suggestions</h3>
    ${listMarkup(ev.learningSuggestions)}</div>

  <div class="content-card"><h3>üìå Why These Scores</h3>
    ${listMarkup(ev.whyTheseScores)}</div>

  <div class="content-card"><h3>üó£Ô∏è Summary Advice</h3>
    <p>${ev.summaryAdvice || '‚Äî'}</p>
  </div>

  <div class="content-card"><h3>üîÆ Recruiter Opinion</h3>
    <p>${ev.recruiterOpinion || '‚Äî'}</p>
  </div>`;
}

// === 3.  JOB-MATCH  RENDERER  =====================================
function renderJobMatch(data = {}) {
  const matchedSkills = listMarkup(data.matchedSkills || []);
  const missingSkills = listMarkup(data.missingSkills || []);
  const suggestions = listMarkup(data.suggestions || []);

  return `
    <div class="job-match-wrapper">
      <div class="job-match-grid">
        <div class="match-card">
          <h3>üìä Match Summary</h3>
          <p><strong>Match Score:</strong> ${data.matchScore ?? '‚Äî'}%</p>
          <p><strong>Skills Score:</strong> ${data.skillsScore ?? '‚Äî'}%</p>
          <p><strong>Tools Score:</strong> ${data.toolsScore ?? '‚Äî'}%</p>
        </div>

        <div class="match-card">
          <h3>‚úÖ Matched Skills</h3>
          ${matchedSkills}

          <h3 style="margin-top: 24px;">‚ùå Missing Skills</h3>
          ${missingSkills}
        </div>
      </div>

      <div class="match-card suggestion-box" style="margin-top: 40px;">
        <h3>üí° AI Suggestions</h3>
        ${suggestions}
      </div>
    </div>
  `;
}

// ========================= 1) Resume-upload handler =========================
const fileInput = document.getElementById('resumeUpload');
fileInput.addEventListener('change', async (event) => {
  // Clear any previous analysis as soon as the user selects a file
  clearSavedAnalysis();

  const file = event.target.files[0];
  if (!file) return;

  // Reset the input value so selecting the same file again still triggers "change"
  fileInput.value = '';

  uploadedFile = file;                // save for later "Compare" step

  // Close any open sections first
  const pageContent = document.getElementById('pageContent');
  if (pageContent) {
    pageContent.style.display = 'none';
    document.querySelectorAll('#pageContent .page').forEach(p => p.style.display = 'none');
  }

  // Disable footer links during loading
  document.querySelector('.footer-content').classList.add('disabled');
  
  const formData = new FormData();
  formData.append('resume', file);    // NOTE: JD NOT sent here

  try {
    await startProgress();            // progress bar starts & upload UI vanishes

    const atsRes  = await fetch('/ats-scan', { method: 'POST', body: formData });
    const atsData = await atsRes.json().catch(() => ({}));   // parse even on 500

    /* Always finish the progress so tabs appear */
    await completeProgress(true);

    /* --- Render ATS view or show an inline error --- */
    const atsView = document.getElementById('atsView');
    if (atsRes.ok && !atsData.error) {
      atsView.innerHTML = renderAtsEvaluation(atsData.atsEvaluation);

      /* load formatted resume into the editor panel */
      if (atsData.originalResumeHTML) {
        document.getElementById('resumeEditor').innerHTML =
          atsData.originalResumeHTML;
      }

      // Inside after successfully rendering ATS evaluation (inside if (atsRes.ok ... ))
      saveAtsData(atsData);
    } else {
      atsView.innerHTML =
        `<p style="color:#e96c6c;">‚ùå Could not analyse resume (server error).</p>`;
    }
  } catch (err) {
    console.error(err);
    /* Complete progress so UI recovers, but flag as failure */
    await completeProgress(true);   // still show tabs
    document.getElementById('atsView').innerHTML =
      '<p style="color:#e96c6c;">‚ùå Unexpected error while analysing resume.</p>';
  }
});

// ==================== 2) "Compare" button handler ===========================
document.getElementById('compareBtn').addEventListener('click', async () => {
  let file = uploadedFile;
  if (!file) {
    alert('Please upload your resume first using the Upload tab before comparing.');
    return;
  }
  const jobDescription = document.getElementById('jdInput').value.trim();
  if (!jobDescription) {
    alert('Please paste a job description before comparing.');
    return;
  }

  // quick visual feedback inside Job-Match tab
  const resultDiv = document.getElementById('compareResult');
  resultDiv.innerHTML = '‚è≥ Comparing‚Ä¶ please wait.';

  const formData = new FormData();
  formData.append('resume', file);
  formData.append('jobDescription', jobDescription);

  try {
    const res = await fetch('/analyze-resume', { method: 'POST', body: formData });
    if (!res.ok) throw new Error('Comparison failed');
    const data = await res.json();

    // render your compare results (simplified example)
    resultDiv.innerHTML = renderJobMatch(data);

    // Inside compareBtn handler, after resultDiv.innerHTML = renderJobMatch(data);
    saveJobMatch(data);
  } catch (err) {
    console.error(err);
    resultDiv.innerHTML = '‚ùå Could not compare resume to job description.';
  }
});

// Initialize event listeners when the DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
  // Theme toggle handler
      const toggle = document.getElementById('modeToggle');
      toggle.checked = localStorage.getItem('theme') === 'dark';
      toggle.addEventListener('change', () => {
        const theme = toggle.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      });

  // Prevent theme toggle from triggering other events
  toggle.addEventListener('click', e => e.stopPropagation());

  // Drag and drop handlers
      const dropZone = document.getElementById('drop-zone');

['dragenter', 'dragover'].forEach(eventName => {
  dropZone.addEventListener(eventName, (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
});

['dragleave', 'drop'].forEach(eventName => {
  dropZone.addEventListener(eventName, (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
  });
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file) {
      const fileInput = document.getElementById('resumeUpload');
      fileInput.files = e.dataTransfer.files;
      fileInput.dispatchEvent(new Event('change'));
    }
  });
});

// Save the current view to local storage
function saveCurrentView(viewId) {
  try { localStorage.setItem('currentView', viewId); } catch{}
}

// Load the current view from local storage
function loadCurrentView() {
  const viewId = localStorage.getItem('currentView');
  const controls = document.getElementById('controls');
  // Hide controls unless we have saved ATS data
  if (!localStorage.getItem('atsData') && controls) {
    controls.style.display = 'none';
  }
  if (viewId && viewId !== 'uploadUI' && localStorage.getItem('atsData')) {
    toggleView(viewId);
  } else {
    toggleView('uploadUI');
  }
}

// Modify toggleView so that controls are shown only when leaving uploadUI
function toggleView(viewId) {
  ['atsView', 'jobMatchView', 'chatView', 'uploadUI'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === viewId) ? 'block' : 'none';
  });
  const controls = document.getElementById('controls');
  if (viewId === 'uploadUI') {
    if (controls) controls.style.display = 'none';
  } else if (uploadedFile && controls) {
    controls.style.display = 'flex';
  }
  if (viewId !== 'uploadUI' && uploadedFile) {
    saveCurrentView(viewId);
  }
}

// === NEW helper to show the static pages =================================================
function showPage(pageId) {
  const wrapper = document.getElementById('pageContent');
  if (!wrapper) return;

  wrapper.style.display = 'block';
  document.querySelectorAll('#pageContent .page')
          .forEach(p => p.style.display = (p.id === pageId) ? 'block' : 'none');

  // Use a reliable timeout to ensure the panel is rendered before scrolling.
  setTimeout(() => {
    wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);

  // update animated heading
  const headerMap = {
    'about'        : { id: 'about-header',  text: 'About ParsePro' },
    'how-it-works' : { id: 'how-header',    text: 'How It Works'   },
    'contact'      : { id: 'contact-header',text: 'Contact Us'     }
  };
  const info = headerMap[pageId];
  if (info) setAnimatedHeader(document.getElementById(info.id), info.text);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 1.  Animated section-title helper (About, How-It-Works, Contact)
function setAnimatedHeader(el, text) {
  if (!el) return;
  el.innerHTML = '';                           // clear previous
  text.split('').forEach((ch, i) => {
    const s = document.createElement('span');
    s.textContent = (ch === ' ') ? '\u00A0' : ch;
    s.style.animationDelay = `${i * 40}ms`;    // stagger letters
    el.appendChild(s);
  });
}

/* 3.  Close the slide-up panel when the user clicks ABOVE it (Temporarily Disabled) */
/*
document.addEventListener('click', e => {
  // if the click was on the theme switch, do nothing
  if (e.target.closest('#modeToggle') || e.target.closest('.switch')) return;

  const wrapper = document.getElementById('pageContent');
  if (wrapper && wrapper.style.display === 'block') {
    const rect = wrapper.getBoundingClientRect();
    if (e.clientY < rect.top) {          // click occurred above the panel
      wrapper.style.display = 'none';
      document.querySelectorAll('#pageContent .page')
              .forEach(p => p.style.display = 'none');
    }
  }
});
*/

// 4.  Contact-form AJAX submit (Formspree)
const contactForm = document.getElementById('contactForm');
if (contactForm) {
  contactForm.addEventListener('submit', async ev => {
    ev.preventDefault();
    try {
      const res = await fetch(contactForm.action, {
        method: 'POST',
        body: new FormData(contactForm),
        headers: { 'Accept': 'application/json' }
      });
      if (res.ok) {
        alert('‚úÖ Thank you! Your message was sent.');
        contactForm.reset();
      } else {
        alert('‚ùå Sorry, there was a problem. Please try again.');
      }
    } catch {
      alert('‚ùå Network error. Please try again.');
    }
  });
}

// === LocalStorage persistence helpers =====================================
function saveAtsData(data) {
  if (!data?.atsEvaluation || data.atsEvaluation.atsScore === 0) return;
  try { localStorage.setItem('atsData', JSON.stringify({ ok:true, data })); } catch{}
}
function saveJobMatch(data) {
  try { localStorage.setItem('jobMatchData', JSON.stringify(data)); } catch {}
}
function clearSavedAnalysis() {
  localStorage.removeItem('atsData');
  localStorage.removeItem('jobMatchData');
}
function loadAtsData() {
  const raw = localStorage.getItem('atsData');
  if (!raw) return;              // nothing stored
  try {
    const payload = JSON.parse(raw);
    if (!payload.ok || !payload.data?.atsEvaluation ||
        payload.data.atsEvaluation.atsScore === 0) {
      clearSavedAnalysis();      // stale or placeholder ‚Üí start fresh
      return;
    }
    // Render ATS view with saved data
    const atsView = document.getElementById('atsView');
    atsView.innerHTML = renderAtsEvaluation(payload.data.atsEvaluation);

    // Restore UI state: hide upload, show controls
    const uploadUI = document.getElementById('uploadUI');
    if (uploadUI) uploadUI.style.display = 'none';
    const progressWrapper = document.getElementById('progressWrapper');
    if (progressWrapper) progressWrapper.style.display = 'none';
    const controls = document.getElementById('controls');
    if (controls) {
      controls.style.display = 'flex';
      controls.classList.add('tabs-transition', 'show');
    }
    document.querySelector('.footer-content')?.classList.remove('disabled');

    toggleView('atsView');

    // Restore resume editor content
    if (payload.data.originalResumeHTML) {
      const editor = document.getElementById('resumeEditor');
      if (editor) editor.innerHTML = payload.data.originalResumeHTML;
    }
  } catch { clearSavedAnalysis(); }
}

// Call loadAtsData on page load
window.addEventListener('DOMContentLoaded', loadAtsData);

// Call loadCurrentView on page load
window.addEventListener('DOMContentLoaded', loadCurrentView);

// Save data to local storage
function saveData(viewId, data) {
  if (!data) return;
  try { localStorage.setItem(viewId, JSON.stringify(data)); } catch{}
}

// Load data from local storage
function loadData(viewId, renderFunction) {
  const raw = localStorage.getItem(viewId);
  if (!raw) return;              // nothing stored
  try {
    const data = JSON.parse(raw);
    if (!data) return;
    // Render view with saved data
    const view = document.getElementById(viewId);
    view.innerHTML = renderFunction(data);
    toggleView(viewId);
  } catch {}
}

// Call loadData for each view on page load
window.addEventListener('DOMContentLoaded', () => {
  loadData('atsView', renderAtsEvaluation);
  loadData('jobMatchView', renderJobMatch);
  // Add similar calls for other views if needed
});

// Add New Upload button handler
const newUploadBtn = document.getElementById('newUploadBtn');
if (newUploadBtn) {
  newUploadBtn.addEventListener('click', () => {
    const proceed = confirm('‚ö†Ô∏è Starting a new upload will clear your current analysis and reload the page. Continue?');
    if (!proceed) return;

    // Clear stored data and refresh to pristine state
    clearSavedAnalysis();
    localStorage.removeItem('currentView');
    uploadedFile = null;
    location.reload();
  });
}
</script>
</body>
</html>