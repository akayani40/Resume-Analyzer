<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Resume Skill Analyzer</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
  </script>
</head>
<body>
  <!-- üåô Toggle -->
  <label class="switch">
    <input type="checkbox" id="modeToggle" />
    <span class="slider round"></span>
  </label>

  <!-- Tabs -->
  <div class="nav-tabs">
    <a href="index.html" class="header-tab active">Tech</a>
    <a href="business.html" class="header-tab">Business</a>
    <a href="science.html" class="header-tab">Science</a>
    <a href="other.html" class="header-tab">Other</a>
  </div>

  <!-- Header -->
  <div class="container">
    <div style="text-align: center; margin-bottom: 40px;">
      <h1 style="font-size: 48px; margin: 0;">ParsePro</h1>
      <p style="font-size: 18px; margin-top: 8px; color: var(--text); opacity: 0.9;">
        Because parsing isn't enough ‚Äî you need insight. See what recruiters (and AI) see.
      </p>
    </div>

    <!-- Upload -->
    <h2>Upload Your Resume</h2>
    <form id="resumeForm" enctype="multipart/form-data">
      <label class="file-upload">
        üìÑ <span id="fileName">Select Your Resume</span>
        <input id="resumeInput" type="file" name="resume" accept=".pdf,.docx,.txt" required />
      </label>
      <br><br>
      <button type="submit">Analyze Resume</button>
    </form>

    <div id="controls" style="display: none;">
      <button onclick="toggleView('result')">üß† Skill View</button>
      <button onclick="toggleView('atsView')">üìÑ ATS View</button>
    </div>

    <div id="result"></div>
    <div id="atsView"></div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('modeToggle');
      if (toggle) {
        toggle.checked = localStorage.getItem('theme') === 'dark';
        toggle.addEventListener('change', () => {
          const theme = toggle.checked ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', theme);
          localStorage.setItem('theme', theme);
        });
      }

      const fileInput = document.getElementById('resumeInput');
      const fileNameSpan = document.getElementById('fileName');
      fileInput.addEventListener('change', () => {
        fileNameSpan.textContent = fileInput.files[0]?.name || "Select Your Resume";
      });
    });

    function toggleView(viewId) {
      document.getElementById('result').style.display = viewId === 'result' ? 'block' : 'none';
      document.getElementById('atsView').style.display = viewId === 'atsView' ? 'block' : 'none';
    }

    document.getElementById('resumeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = document.getElementById('resumeInput').files[0];
      if (!file) {
        document.getElementById('result').innerHTML = '‚ùå Please upload a resume file.';
        return;
      }

      const formData = new FormData();
      formData.append('resume', file);

      document.getElementById('result').innerHTML = '‚è≥ Analyzing...';
      document.getElementById('atsView').innerHTML = '';
      document.getElementById('controls').style.display = 'none';

      try {
        const res = await fetch('/analyze-resume', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.error) {
          document.getElementById('result').innerHTML = '‚ùå ' + data.error;
          return;
        }

        let html = `<h3>‚úÖ Resume Parsed & Categorized</h3>`;
        for (const [cat, skills] of Object.entries(data.categorizedSkills || {})) {
          html += `<div class="category"><h4>${cat}</h4>`;
          html += skills.length ? `<p>${skills.join(', ')}</p>` : `<p class="empty">No skills found.</p>`;
          html += `</div>`;
        }

        if (data.feedback) {
          const feedbackParts = data.feedback.split(/\n\s*\n/);
          html += `<div style="margin-top: 30px;"><h4>üìå Smart Feedback</h4>`;
          feedbackParts.forEach(p => html += `<p>${p.trim()}</p>`);
          html += `</div>`;
        }

        if (data.projectIdeas) {
          const ideas = data.projectIdeas.split(/\n\s*\d+[\.\)]\s*/g).map(p => p.trim()).filter(p => p.length > 10);
          if (ideas.length) {
            html += `<div style="margin-top: 20px;"><h4>üöÄ Project Recommendations</h4>`;
            html += ideas.map(p => `<p>${p}</p>`).join('');
            html += `</div>`;
          }
        }

        if (data.skillStrength) {
          html += `<div style="margin-top: 30px;"><h4>üìä Skill Heatmap</h4><canvas id="skillChart" width="400" height="300"></canvas></div>`;
        }

        document.getElementById('result').innerHTML = html;
        document.getElementById('controls').style.display = 'flex';

        if (data.skillStrength) {
          const ctx = document.getElementById('skillChart').getContext('2d');
          new Chart(ctx, {
            type: 'radar',
            data: {
              labels: Object.keys(data.skillStrength),
              datasets: [{
                label: 'Skill Strength',
                data: Object.values(data.skillStrength),
                fill: true,
                backgroundColor: 'rgba(0, 122, 255, 0.2)',
                borderColor: 'rgba(0, 122, 255, 1)',
                pointBackgroundColor: 'rgba(0, 122, 255, 1)'
              }]
            },
            options: {
              responsive: true,
              scales: {
                r: {
                  suggestedMin: 0,
                  suggestedMax: 10,
                  ticks: { stepSize: 1 }
                }
              }
            }
          });
        }

        // Load ATS Summary
        const atsRes = await fetch('/ats-scan', { method: 'POST', body: formData });
        const atsData = await atsRes.json();
        if (!atsData.error && atsData.atsSummary) {
          const ats = atsData.atsSummary;
          let atsHTML = `<h3>üìÑ ATS Summary View</h3>`;
          atsHTML += `<p><strong>Name:</strong> ${ats.name || '-'}</p>`;
          atsHTML += `<p><strong>Email:</strong> ${ats.email || '-'}</p>`;
          atsHTML += `<p><strong>Phone:</strong> ${ats.phone || '-'}</p>`;

          if (ats.experience?.length) {
            atsHTML += `<h4>Experience:</h4><ul>`;
            ats.experience.forEach(exp => {
              atsHTML += `<li><strong>${exp.title}</strong> at ${exp.company} (${exp.dates})${exp.location ? ' ‚Äì ' + exp.location : ''}</li>`;
            });
            atsHTML += `</ul>`;
          }

          if (ats.education?.length) {
            atsHTML += `<h4>Education:</h4><ul>`;
            ats.education.forEach(ed => {
              atsHTML += `<li>${ed.degree} at ${ed.organization} ${ed.dates ? `(${ed.dates})` : ''}</li>`;
            });
            atsHTML += `</ul>`;
          }

          document.getElementById('atsView').innerHTML = atsHTML;
        }

      } catch (err) {
        console.error(err);
        document.getElementById('result').innerHTML = '‚ùå An unexpected error occurred.';
      }
    });
  </script>
</body>
</html>
